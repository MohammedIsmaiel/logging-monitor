<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta name="description" content="">
    <meta name="author" content="">
    <title>Logs</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous">
</head>

<body class="bg-dark badge-light justify-content-center row">
    <div class="container  row my-3 bg-dark badge-light justify-content-center">
        <form id="logForm" class="col-4 justify-content-center">
            <div class="input-group">
                <button id="submitButton" class="btn btn-primary" type="submit">Show logs</button>
                <select class="form-select" id="logName" aria-label="Example select with button addon">
                    <option selected>Choose a connect to show logs...</option>
                    <!-- <option value="1">One</option>
                    <option value="2">Two</option>
                    <option value="3">Three</option> -->
                    <option th:each="logName : ${logNames}" th:value="${logName}" th:text="${logName}"></option>
                </select>
            </div>

        </form>
        <div class="col-4 justify-content-center">
            <button id="resetButton" type="button" disabled class="mx-1 btn btn-danger">reset</button>
            <button id="logoutButton" onclick=logout() type="submit" class="mx-1 btn btn-info">log out</button>
        </div>
        <div class="row justify-content-center">
            <h4 class="text-light my-3">Logs:</h4>
        </div>
        <div id="messageList " style="color: rgb(50, 212, 50);"
            class="row justify-content-start col-10 border border-primary my-3 mx-3">
            <p class="m-0">Start</p>
            <!-- <p class="m-0">This is default primary text</p> -->
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.6.1/sockjs.min.js"
        integrity="sha512-1QvjE7BtotQjkq8PxLeF6P46gEpBRXuskzIVgjFpekzFVF4yjRgrQvTG1MTOJ3yQgvTteKAcO7DSZI92+u/yZw=="
        crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"
        integrity="sha512-iKDtgDyTHjAitUDdLljGhenhPwrbBfqTKWO1mkhSFH3A7blITC9MhYon6SjnMhp4o0rADGw9yAC6EW4t5a4K3g=="
        crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script>
        var client
        var webSocket = new SockJS('/websocket');
        client = Stomp.over(webSocket);
        const submitButton = document.getElementById('submitButton')
        const resetButton = document.getElementById('resetButton')
        const logName = document.getElementById('logName')
        const messageList = document.getElementById('messageList');
        function generateUserId() {
            return 'user_' + Math.floor(Math.random() * 1000);
        }
        var user_id = generateUserId();

        function logout() {
            var logoutUrl = '/logout/' + user_id;
            window.location.href = logoutUrl;
        }
        client.connect({}, function (frame) {
            console.log('Connected: ' + frame);

            // Modify the client.subscribe line to include the logName
            document.getElementById('logForm').addEventListener('submit', function (event) {
                event.preventDefault(); // Prevent the default form submission behavior
                resetButton.removeAttribute("disabled");
                submitButton.setAttribute("disabled", 'true');
                logName.setAttribute('disabled', 'true');
                messageList.innerHTML = "";
                var logNameValue = document.getElementById('logName').value;
                // Modify the subscription topic
                console.log("TOPIC: ", '/topic/messages/' + encodeURIComponent(user_id) + '/' + encodeURIComponent(logNameValue));
                client.subscribe('/topic/messages/' + encodeURIComponent(user_id) + '/' + encodeURIComponent(logNameValue), function (message) {
                    console.log(message.body);
                    // var messageList = document.getElementById('messageList');
                    // var listItem = document.createElement('li');
                    // var div = '<p class="" >' + message.body + '</p>'
                    var item = document.createElement('p');
                    item.appendChild(document.createTextNode(message.body));
                    item.classList.add('m-0')
                    messageList.appendChild(item);
                });
                var url = '/logs/' + encodeURIComponent(user_id) + '/' + encodeURIComponent(logNameValue);
                fetch(url)
                    .then(response => {
                        if (!response.ok) {
                            throw new Error('Network response was not ok');
                        }
                        return response.text();
                    })
                    .then(data => {
                        console.log('Response:', data);
                    })
                    .catch(error => {
                        console.error('Error:', error);
                    });
            });
        });
        resetButton.addEventListener('click', function (event) {
            event.preventDefault();
            var logNameValue = document.getElementById('logName').value;
            var stopUrl = '/logs/' + encodeURIComponent(user_id) + '/' + encodeURIComponent(logNameValue) + '/stop';
            fetch(stopUrl, {
                method: 'GET'
            })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Network response was not ok');
                    }
                    return response.text();
                })
                .then(data => {
                    console.log('Stop Response:', data);
                })
                .catch(error => {
                    console.error('Error stopping log:', error);
                });

            // logName.removeAttribute('hidden');

            location.reload(true);
            // submitButton.removeAttribute("disabled")
            // homeButton.setAttribute("disabled", 'true')
            // select.removeAttribute('hidden');
            // select.setAttribute('hidden', 'true')
        });

        function connectSocket() {
            // Additional socket connection logic if needed
        }
    </script>


</body>

</html>