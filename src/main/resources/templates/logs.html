<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta name="description" content="">
    <meta name="author" content="">
    <title>Logs</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous">
</head>

<body class="bg-dark badge-light justify-content-center row">
    <div class="container  row my-3 bg-dark badge-light justify-content-center">
        <form id="logForm" class="col-4 justify-content-center">
            <div class="input-group">
                <button id="submitButton" class="btn btn-outline-primary" type="submit">Show logs</button>
                <select class="form-select" id="logName" aria-label="Example select with button addon">
                    <option selected>Choose a connect to show logs...</option>
                    <option value="1">One</option>
                    <option value="2">Two</option>
                    <option value="3">Three</option>
                    <option th:each="logName : ${logNames}" th:value="${logName}" th:text="${logName}"></option>
                </select>
            </div>
            <!-- <div id="select">
                <label for="logName">Choose a log:</label>
                <select id="logName" name="name">
                    <option value="" disabled selected>Select a log</option>
                    <option th:each="logName : ${logNames}" th:value="${logName}" th:text="${logName}"></option>
                </select>
            </div> -->
        </form>
        <div class="col-4 justify-content-center">
            <button id="resetButton" onclick=reset() href="/logs" type="button"
                class="mx-1 btn btn-danger">reset</button>
            <button id="logoutButton" onclick=logout() type="submit" class="mx-1 btn btn-info">log out</button>
        </div>
        <div class="row justify-content-center">
            <h4 class="text-light my-3">Logs:</h4>
        </div>
        <div id="messageList" class="row justify-content-center text-center my-3 mx-3 border border-primary">
            <div class="text-primary">This is default primary text</div>
            <div class="text-primary text-opacity-75">This is 75% opacity primary text</div>
            <div class="text-primary text-opacity-50">This is 50% opacity primary text</div>
            <div class="text-primary text-opacity-25">This is 25% opacity primary text</div>
            <div class="text-light">This is default primary text</div>
            <div class="" style="color: rgb(50, 212, 50);">This is default primary text</div>

            <!-- <ul id="messageList" class="list-group list-group-flush  bg-dark text-start badge-light">
            </ul> -->
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.6.1/sockjs.min.js"
        integrity="sha512-1QvjE7BtotQjkq8PxLeF6P46gEpBRXuskzIVgjFpekzFVF4yjRgrQvTG1MTOJ3yQgvTteKAcO7DSZI92+u/yZw=="
        crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"
        integrity="sha512-iKDtgDyTHjAitUDdLljGhenhPwrbBfqTKWO1mkhSFH3A7blITC9MhYon6SjnMhp4o0rADGw9yAC6EW4t5a4K3g=="
        crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script>
        var client
        var webSocket = new SockJS('/websocket');
        client = Stomp.over(webSocket);
        const submitButton = document.getElementById('submitButton')
        const homeButton = document.getElementById('resetButton')
        const logName = document.getElementById('logName')

        function generateUserId() {
            return 'user_' + Math.floor(Math.random() * 1000);
        }

        function logout() {
            var logoutUrl = 'http://localhost:8080/logout';
            window.location.href = logoutUrl;
        }

        function reset() {
            var resetUrl = 'http://localhost:8080/logs';
            window.location.href = resetUrl;
        }
        var user_id = generateUserId();

        client.connect({}, function (frame) {
            console.log('Connected: ' + frame);

            // Modify the client.subscribe line to include the logName
            document.getElementById('logForm').addEventListener('submit', function (event) {
                event.preventDefault(); // Prevent the default form submission behavior
                homeButton.removeAttribute("disabled")
                submitButton.setAttribute("disabled", 'true')
                logName.setAttribute('hidden', 'true')

                document.getElementById('messageList').innerHTML = "";
                var logName = document.getElementById('logName').value;


                // Modify the subscription topic
                console.log("TOPIC: ", '/topic/messages/' + encodeURIComponent(user_id) + '/' + encodeURIComponent(logName));
                client.subscribe('/topic/messages/' + encodeURIComponent(user_id) + '/' + encodeURIComponent(logName), function (message) {
                    console.log(message.body);
                    var messageList = document.getElementById('messageList');
                    // var listItem = document.createElement('li');
                    var listItem = document.createElement('div');
                    listItem.classList.add('text-primary');
                    listItem.appendChild(document.createTextNode(message.body));
                    messageList.appendChild(listItem);
                });

                var url = '/logs/' + encodeURIComponent(user_id) + '/' + encodeURIComponent(logName);

                fetch(url)
                    .then(response => {
                        if (!response.ok) {
                            throw new Error('Network response was not ok');
                        }
                        return response.text();
                    })
                    .then(data => {
                        console.log('Response:', data);
                    })
                    .catch(error => {
                        console.error('Error:', error);
                    });
            });
        });

        const resetButton = document.getElementById('resetButton');
        resetButton.addEventListener('click', function (event) {
            event.preventDefault();
            var logName = document.getElementById('logName').value;
            var stopUrl = '/logs/' + encodeURIComponent(user_id) + '/' + encodeURIComponent(logName) + '/stop';

            fetch(stopUrl, {
                method: 'GET'
            })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Network response was not ok');
                    }
                    return response.text();
                })
                .then(data => {
                    console.log('Stop Response:', data);
                })
                .catch(error => {
                    console.error('Error stopping log:', error);
                });

            logName.removeAttribute('hidden');

            location.reload(true);
            // submitButton.removeAttribute("disabled")
            // homeButton.setAttribute("disabled", 'true')
            // select.removeAttribute('hidden');
            // select.setAttribute('hidden', 'true')
        });

        function connectSocket() {
            // Additional socket connection logic if needed
        }
    </script>
    <!-- <script>
        var client
        var webSocket = new SockJS('/websocket');
        client = Stomp.over(webSocket);
        const submitButton = document.getElementById('submitButton')
        const homeButton = document.getElementById('homeButton')
        const select = document.getElementById('select')

        client.connect({}, function (frame) {
            console.log('Connected: ' + frame);
            client.subscribe('/topic/messages', function (message) {
                console.log(message.body);
                var messageList = document.getElementById('messageList');
                var listItem = document.createElement('li');
                // listItem.classList.add('list-group-item');
                listItem.classList.add('bg-secondary');
                listItem.classList.add('text-start');
                listItem.classList.add('badge');
                listItem.appendChild(document.createTextNode(message.body));
                messageList.appendChild(listItem);
            });
        });

        document.getElementById('logForm').addEventListener('submit', function (event) {
            event.preventDefault(); // Prevent the default form submission behavior
            // homeButton.setAttribute("disabled", 'false')
            homeButton.removeAttribute("disabled")
            submitButton.setAttribute("disabled", 'true')
            select.setAttribute('hidden', 'true')

            document.getElementById('messageList').innerHTML = "";
            // Get the selected log name from the dropdown
            var logName = document.getElementById('logName').value;

            // Build the URL for the GET request
            var url = '/logs/' + encodeURIComponent(logName);

            // Use the Fetch API to send a GET request
            fetch(url)
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Network response was not ok');
                    }
                    return response.text();
                })
                .then(data => {
                    // Handle the response data as needed
                    console.log('Response:', data);
                })
                .catch(error => {
                    console.error('Error:', error);
                });
        });

        function connectSocket() {

        }

    </script> -->



</body>

</html>